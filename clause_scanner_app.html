<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>약간 스캐너 | 귀여운 AI 동물 친구가 지켜주는 약관 스캐너</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; scroll-behavior: smooth; margin: 0; background-color: #f8fafc; }
        .gradient-text { background: linear-gradient(135deg, #4f46e5, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .bg-gradient-custom { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .reveal { opacity: 0; transform: translateY(30px); transition: all 0.8s ease-out; }
        .reveal.active { opacity: 1; transform: translateY(0); }
        
        /* 모달 설정 */
        #summaryModal, #guideModal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

        #view-app { display: block; background-color: #F1F5F9; min-height: 100vh; }
        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #FFFFFF;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .screen { display: none; flex: 1; flex-direction: column; padding: 24px; box-sizing: border-box; }
        .screen.active { display: flex; }
        
        /* 스캔 애니메이션 */
        .scan-line {
            width: 100%; height: 4px;
            background: linear-gradient(to right, transparent, #4F46E5, transparent);
            position: absolute; top: 0; animation: scan 2s infinite ease-in-out;
            box-shadow: 0 0 15px #4F46E5;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 캐릭터 애니메이션 효과 */
        @keyframes angry-shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-2px, 1px) rotate(-2deg); }
            50% { transform: translate(2px, -1px) rotate(2deg); }
            75% { transform: translate(-2px, -1px) rotate(-1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .animate-angry { animation: angry-shake 0.15s infinite; }
        
        /* 통통 튀는 애니메이션 */
        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-jump { animation: jump 0.6s infinite ease-in-out; }
        
        /* 입력 폼 */
        .input-group { position: relative; margin-top: 25px; width: 100%; }
        .input-group input {
            width: 100%; padding: 12px 0 12px 35px; font-size: 16px; color: #1e293b;
            border: none; border-bottom: 2px solid #e2e8f0; outline: none; background: transparent; transition: border-color 0.3s;
        }
        .input-group i { position: absolute; left: 5px; top: 14px; color: #94a3b8; font-size: 18px; }
        .input-group input:focus { border-bottom-color: #4f46e5; }
        .input-group label {
            position: absolute; top: 12px; left: 35px; color: #94a3b8; pointer-events: none; transition: all 0.3s ease;
        }
        .input-group input:focus + label,
        .input-group input:not(:placeholder-shown) + label {
            top: -15px; left: 0; font-size: 12px; color: #4f46e5; font-weight: 700;
        }

        /* 토글 버튼 */
        .toggle-btn {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px; background: #F8FAFC; border-radius: 18px; cursor: pointer; transition: 0.2s; border: 2px solid transparent;
        }
        .toggle-btn.active { border-color: #4F46E5; background: #EEF2FF; }
        .toggle-dot { width: 24px; height: 24px; background: #CBD5E1; border-radius: 50%; transition: 0.3s; position: relative; }
        .toggle-btn.active .toggle-dot { background: #4F46E5; transform: translateX(12px); }
        
        /* 텍스트 영역 */
        .textarea-container {
            background: #F8FAFC; border-radius: 24px; padding: 20px; border: 1px solid #E2E8F0; flex: 1; display: flex; margin-bottom: 20px;
        }
        #termsInput {
            width: 100%; height: 100%; min-height: 250px; background: transparent; border: none; outline: none; resize: none; font-size: 14px; line-height: 1.6; color: #334155;
        }

        .selection-card { border: 2px solid #f1f5f9; transition: all 0.3s ease; }
        .selection-card:hover { border-color: #4F46E5; background-color: #f5f3ff; transform: translateY(-3px); }

        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: #4f46e5; transition: width 2s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- [VIEW 2] APP SERVICE -->
    <div id="view-app">
        <div class="app-container">
            <header id="app-header" class="hidden px-6 py-4 flex justify-between items-center border-b border-slate-100 bg-white sticky top-0 z-50">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-xs font-bold"><i class="fa-solid fa-dog"></i></div>
                    <h1 class="font-bold text-lg text-slate-800">약간 스캐너</h1>
                </div>
                <button class="text-slate-400 hover:text-indigo-600 transition-colors" onclick="handleLogout()" title="로그아웃/마이페이지"><i class="fa-solid fa-circle-user text-2xl"></i></button>
            </header>

            <main class="flex-1 flex flex-col">
                <!-- Screen: Login -->
                <section id="screen-login" class="screen active justify-center items-center text-center fade-in">
                    <div class="mb-8">
                        <div class="w-20 h-20 bg-indigo-50 rounded-[2.5rem] flex items-center justify-center text-indigo-600 text-4xl mb-6 mx-auto shadow-sm"><i class="fa-solid fa-dog"></i></div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">약간 스캐너</h2>
                        <p class="text-slate-400 text-sm">내 권리를 지키기 위해 로그인하세요.</p>
                    </div>
                    <div class="w-full px-4 mb-8">
                        <div class="input-group text-left"><i class="fa-solid fa-at"></i><input type="text" id="loginId" placeholder=" "><label>아이디 (이메일)</label></div>
                        <div class="input-group text-left mt-4"><i class="fa-solid fa-lock"></i><input type="password" id="loginPw" placeholder=" "><label>비밀번호</label></div>
                        <div class="input-group text-left mt-4"><i class="fa-solid fa-key"></i><input type="password" id="apiKey" placeholder=" "><label>API 키 (선택사항 - 환경 변수 설정 시 생략 가능)</label></div>
                        <p class="text-xs text-slate-400 mt-4 text-left px-1">API 키는 환경 변수로 설정되어 있으면 생략 가능합니다.</p>
                    </div>
                    <div class="w-full px-4">
                        <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all">로그인</button>
                        <a href="index.html" class="mt-6 text-xs text-slate-400 font-medium inline-block">← 랜딩 페이지로 돌아가기</a>
                    </div>
                </section>

                <!-- Screen: Preferences -->
                <section id="screen-prefs" class="screen fade-in">
                    <div class="mt-8 mb-6 flex justify-between items-end">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 leading-tight"><span class="user-name">이민수</span>님, <br>보안 설정을 선택하세요!</h2>
                        </div>
                        <button onclick="openGuide()" class="text-indigo-600 text-xs font-bold flex items-center gap-1 bg-indigo-50 px-3 py-2 rounded-full mb-1">
                            <i class="fa-solid fa-circle-info"></i> 도움말
                        </button>
                    </div>
                    <div class="space-y-4 flex-1 overflow-y-auto pb-4">
                        <div class="toggle-btn active" id="pref-money" onclick="togglePref('money')">
                            <div class="flex items-center gap-4 w-full">
                                <div class="icon-box w-10 h-10 shrink-0 bg-rose-100 rounded-xl flex items-center justify-center text-rose-500 transition-colors"><i class="fa-solid fa-credit-card"></i></div>
                                <div class="flex-1"><h4 class="font-bold text-sm text-slate-800">1단계: 금융 사고 방지</h4><p class="text-[10px] text-slate-400">자동 유료 전환 조항 감시</p></div>
                            </div>
                            <div class="toggle-dot shrink-0" style="background:#4F46E5; transform:translateX(12px);"></div>
                        </div>
                        <div class="toggle-btn active" id="pref-ads" onclick="togglePref('ads')">
                            <div class="flex items-center gap-4 w-full">
                                <div class="icon-box w-10 h-10 shrink-0 bg-amber-100 rounded-xl flex items-center justify-center text-amber-500 transition-colors"><i class="fa-solid fa-bullhorn"></i></div>
                                <div class="flex-1"><h4 class="font-bold text-sm text-slate-800">2단계: 마케팅 스팸 차단</h4><p class="text-[10px] text-slate-400">제3자 개인정보 제공 감시</p></div>
                            </div>
                            <div class="toggle-dot shrink-0" style="background:#4F46E5; transform:translateX(12px);"></div>
                        </div>
                        <div class="toggle-btn" id="pref-phone" onclick="togglePref('phone')">
                            <div class="flex items-center gap-4 w-full">
                                <div class="icon-box w-10 h-10 shrink-0 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400 transition-colors"><i class="fa-solid fa-phone"></i></div>
                                <div class="flex-1"><h4 class="font-bold text-sm text-slate-800">3단계: 연락처 보호</h4><p class="text-[10px] text-slate-400">불필요한 번호 수집 감시</p></div>
                            </div>
                            <div class="toggle-dot shrink-0"></div>
                        </div>
                        <div class="toggle-btn" id="pref-address" onclick="togglePref('address')">
                            <div class="flex items-center gap-4 w-full">
                                <div class="icon-box w-10 h-10 shrink-0 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400 transition-colors"><i class="fa-solid fa-location-dot"></i></div>
                                <div class="flex-1"><h4 class="font-bold text-sm text-slate-800">4단계: 공간 주권 보호</h4><p class="text-[10px] text-slate-400">실시간 위치 정보 수집 감시</p></div>
                            </div>
                            <div class="toggle-dot shrink-0"></div>
                        </div>
                    </div>
                    <button onclick="savePrefs()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold mt-4 shadow-lg active:scale-95 transition-all">내 친구 적용하기</button>
                </section>

                <!-- Screen: Home -->
                <section id="screen-home" class="screen fade-in justify-center">
                    <div class="mb-10 text-center">
                        <h2 class="text-2xl font-bold text-slate-900">분석할 약관을 준비하세요</h2>
                        <p class="text-slate-500 mt-2 text-sm">동물 친구가 스캔해 드릴게요!</p>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="selection-card p-6 rounded-3xl cursor-pointer flex items-center gap-6" onclick="navTo('input-text')">
                            <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 text-3xl"><i class="fa-solid fa-paste"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800">텍스트 붙여넣기</h4>
                                <p class="text-xs text-slate-400">약관을 복사해오셨나요?</p>
                            </div>
                            <i class="fa-solid fa-chevron-right ml-auto text-slate-300"></i>
                        </div>
                        <!-- 이미지 스캔 기능 활성화 -->
                        <div class="selection-card p-6 rounded-3xl cursor-pointer flex items-center gap-6" onclick="triggerImageUpload()">
                            <div class="w-16 h-16 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 text-3xl"><i class="fa-solid fa-camera"></i></div>
                            <div>
                                <h4 class="font-bold text-slate-800">이미지 스캔 (OCR)</h4>
                                <p class="text-xs text-slate-400">약관을 사진으로 찍으셨나요?</p>
                            </div>
                            <i class="fa-solid fa-chevron-right ml-auto text-slate-300"></i>
                        </div>
                        <!-- 숨겨진 파일 입력 -->
                        <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageSelection(event)">
                    </div>
                </section>

                <!-- Screen: Text Input -->
                <section id="screen-input-text" class="screen fade-in">
                    <div class="flex items-center gap-2 mb-6">
                        <button onclick="navTo('home')" class="text-slate-400 p-2"><i class="fa-solid fa-chevron-left"></i></button>
                        <h2 class="text-xl font-bold text-slate-900">약관 내용 입력</h2>
                    </div>
                    <div class="textarea-container">
                        <textarea id="termsInput" placeholder="분석하고 싶은 약관이나 개인정보 처리방침을 이곳에 붙여넣으세요..." spellcheck="false"></textarea>
                    </div>
                    <button onclick="startAnalysis()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all">3초 정밀 스캔 시작</button>
                </section>

                <!-- Screen: Loading -->
                <section id="screen-loading" class="screen items-center justify-center text-center">
                    <div class="relative w-48 h-64 bg-slate-50 rounded-[3rem] border-8 border-slate-100 overflow-hidden flex items-center justify-center">
                        <div class="scan-line"></div>
                        <i class="fa-solid fa-dog text-7xl text-indigo-100 animate-jump"></i>
                    </div>
                    <div class="mt-10">
                        <h3 id="loading-text" class="text-xl font-bold text-slate-900">다크 패턴 탐지 중...</h3>
                        <p id="loading-subtext" class="text-slate-400 text-sm mt-2">동물 친구들이 열심히 찾고 있어요!</p>
                    </div>
                    <div class="w-full max-w-xs mt-12 px-6">
                        <div class="progress-bar"><div id="loadingBar" class="progress-fill"></div></div>
                    </div>
                </section>

                <!-- Screen: Result -->
                <section id="screen-result" class="screen fade-in overflow-y-auto">
                    <div class="flex items-center justify-between mb-8">
                        <button onclick="navTo('home')" class="text-slate-400 p-2"><i class="fa-solid fa-house"></i></button>
                        <h2 class="text-xl font-bold text-slate-900">분석 리포트</h2>
                        <button onclick="downloadReport()" class="text-slate-400 p-2"><i class="fa-solid fa-download"></i></button>
                    </div>
                    <div class="bg-white rounded-[2.5rem] p-8 border border-slate-100 shadow-2xl mb-8 text-center relative overflow-hidden">
                        <div id="grade-container" class="relative z-10">
                             <div id="grade-icon-box" class="mb-2 text-5xl"></div>
                             <div id="grade-circle" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl font-black text-white shadow-lg">C</div>
                        </div>
                        <h2 id="result-grade-text" class="text-2xl font-bold text-slate-900">주의가 필요합니다!</h2>
                        <p class="mt-2 text-xs text-slate-400"><span class="user-name">이민수</span>님의 보안 설정 기준 분석 결과</p>
                    </div>
                    
                    <div class="mb-6"><h4 class="font-bold text-slate-800 mb-4 px-1 text-sm">위험 조항 리포트</h4><div id="risk-list" class="space-y-4"></div></div>
                    
                    <div class="bg-indigo-50 p-6 rounded-3xl mb-24">
                        <h4 class="font-bold text-indigo-900 flex items-center gap-2 mb-2 text-sm"><i class="fa-solid fa-paw text-amber-500"></i> 동물 친구의 조언</h4>
                        <p id="one-point-advice" class="text-xs text-indigo-700 leading-relaxed"></p>
                    </div>
                    
                    <button onclick="navTo('home')" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-2xl mb-4">다른 약관 분석하기</button>
                </section>
            </main>
        </div>
    </div>

    <!-- [MODALS] -->
    <div id="guideModal" class="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-950/60 backdrop-blur-sm opacity-0 invisible">
        <div class="modal-content bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden transform scale-90">
            <div class="p-6 bg-indigo-600 text-white flex justify-between items-center"><h4 class="font-bold text-lg">동물 친구들의 가이드</h4><button onclick="closeGuide()" class="text-white/60 hover:text-white"><i class="fa-solid fa-xmark"></i></button></div>
            <div class="p-8 space-y-6 text-sm text-slate-600 leading-relaxed">
                <div class="flex gap-4">
                    <div class="w-10 h-10 shrink-0 bg-rose-50 text-rose-500 flex items-center justify-center rounded-xl font-bold">1</div>
                    <p><strong>금융사고 방지:</strong> 무료 체험 후 몰래 자동 결제로 전환되는 조항을 1순위로 잡아냅니다.</p>
                </div>
                <div class="flex gap-4">
                    <div class="w-10 h-10 shrink-0 bg-amber-50 text-amber-500 flex items-center justify-center rounded-xl font-bold">2</div>
                    <p><strong>마케팅 차단:</strong> 내 연락처가 광고 대행사나 보험사에 팔리는 '제3자 제공'을 감시합니다.</p>
                </div>
                <div class="flex gap-4">
                    <div class="w-10 h-10 shrink-0 bg-indigo-50 text-indigo-500 flex items-center justify-center rounded-xl font-bold">3</div>
                    <p><strong>연락처 보호:</strong> 앱 이용과 상관없는 과도한 개인정보 수집 시 체크 해제를 권고합니다.</p>
                </div>
                <div class="flex gap-4">
                    <div class="w-10 h-10 shrink-0 bg-slate-50 text-slate-500 flex items-center justify-center rounded-xl font-bold">4</div>
                    <p><strong>공간 주권:</strong> 상시적인 실시간 위치 추적 조항이 있는지 정밀 대조합니다.</p>
                </div>
            </div>
            <div class="p-6 border-t"><button onclick="closeGuide()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">확인했습니다</button></div>
        </div>
    </div>

    <script>
        let userName = "이민수";
        let userPrefs = { phone: false, address: false, money: true, ads: true };
        let apiKey = '';
        let analysisResult = null;

        function navTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');
            if(screenId === 'loading') {
                document.getElementById('loadingBar').style.width = '100%';
            } else {
                document.getElementById('loadingBar').style.width = '0%';
            }
            window.scrollTo(0, 0);
        }

        function handleLogout() {
            document.getElementById('app-header').classList.add('hidden');
            navTo('login');
            handleAlert("로그아웃 되었습니다.");
        }

        function handleLogin() {
            const inputId = document.getElementById('loginId').value.trim();
            const inputApiKey = document.getElementById('apiKey').value.trim();
            
            if (inputId) {
                userName = inputId.split('@')[0] || inputId || "이민수";
            }
            if (inputApiKey) {
                apiKey = inputApiKey;
            }
            
            updateUserContext();
            navTo('prefs');
        }
        
        function updateUserContext() { 
            document.querySelectorAll('.user-name').forEach(el => el.innerText = userName); 
        }

        function togglePref(id) {
            userPrefs[id] = !userPrefs[id];
            const btn = document.getElementById('pref-' + id);
            btn.classList.toggle('active');
            const dot = btn.querySelector('.toggle-dot');
            dot.style.transform = userPrefs[id] ? 'translateX(12px)' : 'translateX(0px)';
            dot.style.background = userPrefs[id] ? '#4F46E5' : '#CBD5E1';
            const iconBox = btn.querySelector('.icon-box');
            if (userPrefs[id]) {
                if (id === 'money') iconBox.className = "icon-box w-10 h-10 shrink-0 bg-rose-100 rounded-xl flex items-center justify-center text-rose-500 transition-colors";
                else if (id === 'ads') iconBox.className = "icon-box w-10 h-10 shrink-0 bg-amber-100 rounded-xl flex items-center justify-center text-amber-500 transition-colors";
                else iconBox.className = "icon-box w-10 h-10 shrink-0 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-500 transition-colors";
            } else {
                iconBox.className = "icon-box w-10 h-10 shrink-0 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400 transition-colors";
            }
        }

        function savePrefs() { 
            navTo('home'); 
            document.getElementById('app-header').classList.remove('hidden'); 
        }

        function openGuide() {
            const m = document.getElementById('guideModal'); 
            m.classList.remove('invisible'); 
            m.classList.add('opacity-100');
            m.querySelector('.modal-content').classList.replace('scale-90', 'scale-100');
        }
        function closeGuide() {
            const m = document.getElementById('guideModal'); 
            m.classList.remove('opacity-100'); 
            m.classList.add('invisible');
            m.querySelector('.modal-content').classList.replace('scale-100', 'scale-90');
        }

        // 이미지 파일 업로드 트리거
        function triggerImageUpload() {
            document.getElementById('imageInput').click();
        }

        // 이미지 선택 처리 (OCR 시뮬레이션 - 실제 OCR API 연동 필요)
        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (file) {
                // OCR 시뮬레이션 시작
                navTo('loading');
                document.getElementById('loading-text').innerText = "이미지에서 텍스트 추출 중...";
                document.getElementById('loading-subtext').innerText = "OCR 엔진이 약관 글씨를 읽고 있어요!";
                
                // 실제로는 여기에 OCR API 호출이 들어가야 합니다
                // 현재는 시뮬레이션으로 처리
                setTimeout(() => {
                    document.getElementById('loading-text').innerText = "다크 패턴 탐지 중...";
                    document.getElementById('loading-subtext').innerText = "동물 친구들이 위험 요소를 찾고 있어요!";
                    
                    // 가상의 OCR 결과물로 분석 수행
                    const simulatedText = "제5조 유료 멤버십은 무료 체험 7일 후 자동으로 유료 결제 전환됩니다. 또한 개인정보는 마케팅 목적으로 제3자에게 제공될 수 있습니다.";
                    document.getElementById('termsInput').value = simulatedText;
                    startAnalysis();
                    handleAlert("멍멍! 사진 속 약관을 모두 읽어냈어요!");
                }, 2000);
            }
        }

        // 텍스트 영역에 약관 붙여넣기 이벤트 감지
        document.addEventListener('DOMContentLoaded', function() {
            const termsInput = document.getElementById('termsInput');
            if (termsInput) {
                termsInput.addEventListener('paste', () => {
                    setTimeout(() => {
                        handleAlert("멍멍! 약관이 감지되었어요. 분석 버튼을 눌러주세요!");
                    }, 100);
                });
            }
        });

        async function startAnalysis() {
            const input = document.getElementById('termsInput').value.trim();
            if (!input.trim()) return handleAlert('분석할 약관을 입력하세요.');
            
            document.getElementById('loading-text').innerText = "다크 패턴 탐지 중...";
            document.getElementById('loading-subtext').innerText = "동물 친구들이 열심히 찾고 있어요!";
            navTo('loading');
            
            try {
                // API URL 자동 감지
                const apiUrl = window.location.hostname === 'localhost' 
                    ? 'http://localhost:3000/api/analyze'
                    : '/api/analyze';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: input,
                        apiKey: apiKey || undefined,
                        model: 'gemini'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: '알 수 없는 오류가 발생했습니다.' }));
                    throw new Error(errorData.error || errorData.message || `서버 오류 (${response.status})`);
                }

                const result = await response.json();
                analysisResult = result;
                renderResult(result);
                navTo('result');
            } catch (error) {
                console.error('Error:', error);
                const errorMessage = error.message || '분석 중 오류가 발생했습니다. API 키를 확인하거나 나중에 다시 시도해주세요.';
                handleAlert(errorMessage);
                navTo('input-text');
            }
        }

        function renderResult(result) {
            const list = document.getElementById('risk-list');
            list.innerHTML = "";
            
            const risks = result.risk_report || [];
            
            if (risks.length === 0) {
                list.innerHTML = `
                    <div class="bg-emerald-50 border-l-4 border-emerald-500 p-6 rounded-2xl flex gap-4">
                        <div class="text-3xl shrink-0 pt-1"><i class="fa-solid fa-dog animate-jump text-emerald-500"></i></div>
                        <div class="flex-1">
                            <span class="bg-emerald-500 text-white text-[9px] px-2 py-1 rounded-full font-black uppercase">Green Risk</span>
                            <h5 class="font-bold text-emerald-900 mt-2 text-sm">표준 약관 준수</h5>
                            <p class="text-[11px] text-slate-500 mt-2 leading-relaxed">공정거래위원회 온라인 서비스 표준약관을 충실히 따르고 있으며 독소 조항이 발견되지 않았습니다.</p>
                        </div>
                    </div>
                `;
            } else {
                risks.forEach(risk => {
                    const colorClass = risk.level === 'Red' ? 'rose' : (risk.level === 'Yellow' ? 'amber' : 'emerald');
                    let iconHtml = '';
                    if(risk.level === 'Red') iconHtml = '<i class="fa-solid fa-dog animate-angry text-rose-500"></i>';
                    else if(risk.level === 'Yellow') iconHtml = '<i class="fa-solid fa-dog animate-pulse text-amber-500"></i>';
                    else iconHtml = '<i class="fa-solid fa-dog animate-jump text-emerald-500"></i>';

                    list.innerHTML += `
                        <div class="bg-${colorClass}-50 border-l-4 border-${colorClass}-500 p-6 rounded-2xl flex gap-4">
                            <div class="text-3xl shrink-0 pt-1">${iconHtml}</div>
                            <div class="flex-1">
                                <span class="bg-${colorClass}-500 text-white text-[9px] px-2 py-1 rounded-full font-black uppercase">${risk.level} Risk</span>
                                <h5 class="font-bold text-${colorClass}-900 mt-2 text-sm">${risk.clause_title || '위험 조항'}</h5>
                                <p class="text-[11px] text-slate-500 mt-2 leading-relaxed">${risk.easy_explanation || ''}</p>
                                <div class="mt-3 pt-3 border-t border-${colorClass}-200 text-[10px] text-${colorClass}-700 font-bold">
                                    <i class="fa-solid fa-paw"></i> 가이드: ${risk.action_guide || ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            const gradeCircle = document.getElementById('grade-circle');
            const gradeText = document.getElementById('result-grade-text');
            const advice = document.getElementById('one-point-advice');
            const gradeIconBox = document.getElementById('grade-icon-box');
            
            const safetyGrade = result.safety_grade || 'C';
            const hasRed = risks.some(r => r.level === 'Red');
            const hasYellow = risks.some(r => r.level === 'Yellow');
            
            if (hasRed || ['D', 'E'].includes(safetyGrade)) {
                gradeIconBox.innerHTML = '<i class="fa-solid fa-dog animate-angry text-rose-500"></i>';
                gradeCircle.innerText = safetyGrade;
                gradeCircle.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl font-black text-white bg-rose-500 shadow-lg shadow-rose-100";
                gradeText.innerText = "멍! 조심하세요!";
                gradeText.className = "text-2xl font-bold text-rose-600";
                advice.innerText = result.one_point_advice || `${userName}님, 화난 강아지가 위험을 감지했어요! 특히 자동 결제 조항은 매우 위험하니 주의하세요.`;
            } else if (hasYellow || safetyGrade === 'C') {
                gradeIconBox.innerHTML = '<i class="fa-solid fa-dog animate-pulse text-amber-500"></i>';
                gradeCircle.innerText = safetyGrade;
                gradeCircle.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl font-black text-white bg-amber-500 shadow-lg shadow-amber-100";
                gradeText.innerText = "멍! 확인이 필요해요";
                gradeText.className = "text-2xl font-bold text-amber-600";
                advice.innerText = result.one_point_advice || "강아지가 갸우뚱하고 있어요. 큰 리스크는 없지만 마케팅 활용 동의는 피하는 것이 좋습니다.";
            } else {
                gradeIconBox.innerHTML = '<i class="fa-solid fa-dog animate-jump text-emerald-500"></i>';
                gradeCircle.innerText = safetyGrade;
                gradeCircle.className = "w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl font-black text-white bg-emerald-500 shadow-lg shadow-emerald-100";
                gradeText.innerText = "멍멍! 안심하세요!";
                gradeText.className = "text-2xl font-bold text-emerald-600";
                advice.innerText = result.one_point_advice || "강아지가 기분 좋게 뛰고 있어요! 사용자의 권리를 존중하는 아주 착한 서비스입니다.";
            }
        }

        function downloadReport() {
            if (!analysisResult) return handleAlert('저장할 분석 결과가 없습니다.');
            const dataStr = JSON.stringify(analysisResult, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `약관분석결과_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            handleAlert('분석 결과가 다운로드되었습니다.');
        }

        function handleAlert(m) { 
            const msgBox = document.createElement('div');
            msgBox.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-4 rounded-2xl text-sm font-bold shadow-2xl z-[300] fade-in";
            msgBox.innerText = m;
            document.body.appendChild(msgBox);
            setTimeout(() => msgBox.remove(), 2500);
        }
    </script>
</body>
</html>
